<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --accent: #e74c3c;
            --background: #ecf0f1;
            --text: #2c3e50;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--background);
            min-height: 100vh;
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 900px;
            width: 100%;
            padding: 2rem;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            padding: 2rem;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .active {
            display: block;
        }

        h1, h2, h3 {
            margin-bottom: 1rem;
            text-align: center;
            color: var(--primary);
        }

        /* Welcome Screen */
        #welcomeScreen {
            text-align: center;
        }

        /* Login Screen */
        #loginScreen {
            text-align: center;
        }

        .avatar-upload {
            position: relative;
            width: 150px;
            margin: 1rem auto;
        }

        #avatarPreview,
        #editAvatarPreview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        #avatarPreview:hover,
        #editAvatarPreview:hover {
            transform: scale(1.05);
        }

        .symbol-selection {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
        }

        .symbol-selection label {
            cursor: pointer;
        }

        .symbol-selection input:checked + span {
            background: var(--primary);
            color: white;
        }

        /* Lobby Screen */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            background: var(--background);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        #userAvatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .profile-actions {
            position: relative;
            margin-left: auto;
        }

        .profile-actions .btn {
            background-color: var(--text);
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dropdown {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--shadow);
            padding: 0.5rem;
            z-index: 100;
        }

        .dropdown.show {
            display: block;
        }

        #usersList {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .player-card {
            background: var(--background);
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .player-info {
            flex-grow: 1;
        }

        .player-symbol {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }

        /* Game Screen */
        #gameScreen {
            text-align: center;
        }

        #gameBoard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 2rem auto;
            background: var(--primary);
            padding: 10px;
            border-radius: 1rem;
            box-shadow: var(--shadow);
        }

        .cell {
            aspect-ratio: 1;
            background: white;
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cell:hover {
            background: var(--background);
        }

        .cell.x {
            color: var(--accent);
        }

        .cell.o {
            color: var(--secondary);
        }

        .cell.win {
            background: rgba(46, 204, 113, 0.2);
        }

        /* Popup */
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
            animation: scaleIn 0.3s ease-in-out;
        }

        @keyframes scaleIn {
            from {
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        /* Edit Profile Popup */
        #editProfilePopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
        }

        #editProfilePopup.show {
            display: block;
        }

        #editProfileForm {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Utility Classes */
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.5rem;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--background);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #bdc3c7;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        input[type="text"],
        select {
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            width: 75%;
            margin: 0.5rem 0;
            font-size: 1rem;
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .screen {
                padding: 1rem;
            }

            #gameBoard {
                max-width: 250px;
            }

            .cell {
                font-size: 2.5rem;
            }

            .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }

            input[type="text"],
            select {
                width: 72%;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.3rem;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .profile-actions {
                margin-left: 0;
                margin-top: 1rem;
            }

            #gameBoard {
                max-width: 200px;
            }

            .cell {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen active">
            <h1>Welcome to Advanced Tic Tac Toe Game</h1>
            <p>Play with friends online or challenge our AI-Bot</p>
            <button class="btn btn-primary" onclick="showScreen('loginScreen')">
                Start Game
            </button>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="screen">
            <h2>Create Your Profile</h2>
            <div class="avatar-upload">
                <input type="file" id="avatarInput" accept="image/*" hidden>
                <img id="avatarPreview" src="https://via.placeholder.com/150">
                <button class="btn btn-secondary" onclick="document.getElementById('avatarInput').click()">
                    <img src="upload.png" class="icon" alt="">
                    Upload Picture
                </button>
            </div>
            <input type="text" id="username" placeholder="Enter your name">
            <div class="symbol-selection">
                <label>
                    <input type="radio" name="symbol" value="X" id="symbolX" checked hidden>
                    <span class="btn btn-secondary">X</span>
                </label>
                <label>
                    <input type="radio" name="symbol" id="symbolO" value="O" hidden>
                    <span class="btn btn-secondary">O</span>
                </label>
            </div>
            <button class="btn btn-primary" onclick="login()">Join Game</button>
        </div>

        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="screen">
            <div class="profile-header">
                <img id="userAvatar" src="https://via.placeholder.com/60" alt="User Avatar">
                <h2>Welcome, <span id="userName"></span> (Symbol : <span id="userSymbol"></span>)</h2>
                <div class="profile-actions">
                    <button class="btn" onclick="toggleDropdown()">
                        <img src="image.png" class="icon" alt="">
                        Profile
                    </button>
                    <div id="profileDropdown" class="dropdown">
                        <button class="btn btn-secondary" onclick="editProfile()">
                            <img src="edit-info.png" class="icon" alt="">
                            Edit Profile
                        </button>
                        <button class="btn btn-secondary" onclick="showUserStats()">
                            <img src="data-management.png" class="icon" alt="">
                            View Stats
                        </button>
                        <button class="btn btn-secondary" onclick="logout()">
                            <img src="logout.png" class="icon" alt="">
                            Logout
                        </button>
                    </div>
                </div>
            </div>

            <div class="ai-section">
                <h3>Play With AI-Bot</h3>
                <select id="aiDifficulty" class="btn btn-secondary">
                    <option value="easy">🟩 Easy 😃</option>
                    <option value="medium">🟨 Medium 😐</option>
                    <option value="hard">🟥 Hard 😈</option>
                </select>
                <button class="btn btn-primary" onclick="startAIGame()">Play With AI</button>
            </div>

            <h3>Play With Online Players</h3>
            <div id="usersList"></div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <button class="btn btn-secondary" onclick="backToLobby()"><img src="left-arrow.png" class="icon" alt="">Back to Lobby</button>
            <h2 id="gameStatus"></h2>
            <div id="gameBoard"></div>
        </div>

        <!-- Result Popup -->

        <div id="resultPopup" class="popup">
            <h2 id="resultText"></h2>
            <div class="game-actions">
                <button class="btn btn-secondary" onclick="backToLobby()"><img src="left-arrow.png" class="icon" alt="">Back to Lobby</button>
            </div>
        </div>

        <!-- Challenge Popup -->
        <div id="challengePopup" class="popup">
            <h2 id="challengeText"></h2>
            <button class="btn btn-primary" onclick="acceptChallenge()">Accept</button>
            <button class="btn btn-secondary" onclick="declineChallenge()">Decline</button>
        </div>

        <!-- User Stats Popup -->
        <div id="userStatsPopup" class="popup">
            <h2>Your Stats</h2>
            <p>Games Played: <span id="gamesPlayed"></span></p>
            <p>Wins: <span id="wins"></span></p>
            <p>Losses: <span id="losses"></span></p>
            <p>Draws: <span id="draws"></span></p>
            <p>Experience: <span id="experience"></span></p>
            <button class="btn btn-secondary" onclick="closeUserStats()">Close</button>
        </div>

        <!-- Edit Profile Popup -->
        <div id="editProfilePopup" class="popup">
            <h2>Edit Profile</h2>
            <form id="editProfileForm">
                <div class="avatar-upload">
                    <input type="file" id="editAvatarInput" accept="image/*" hidden>
                    <img id="editAvatarPreview" src="https://via.placeholder.com/150" alt="Avatar">
                    <button type="button" class="btn btn-secondary"
                        onclick="document.getElementById('editAvatarInput').click()">Choose Avatar</button>
                </div>
                <input type="text" id="editUsername" placeholder="Enter your name">
                <div class="symbol-selection">
                    <label>
                        <input type="radio" name="editSymbol" value="X" hidden>
                        <span class="btn btn-secondary">X</span>
                    </label>
                    <label>
                        <input type="radio" name="editSymbol" value="O" hidden>
                        <span class="btn btn-secondary">O</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditProfilePopup()">Cancel</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUser = null;
        let onlineUsers = [];
        let gameState = {
            board: Array(9).fill(null),
            currentPlayer: 'X',
            roomId: null,
            isMultiplayer: false,
            difficulty: 'easy',
            gameActive: false
        };

        // DOM Elements
        const elements = {
            screens: {
                welcome: document.getElementById('welcomeScreen'),
                login: document.getElementById('loginScreen'),
                lobby: document.getElementById('lobbyScreen'),
                game: document.getElementById('gameScreen')
            },
            avatarPreview: document.getElementById('avatarPreview'),
            username: document.getElementById('username'),
            gameBoard: document.getElementById('gameBoard'),
            gameStatus: document.getElementById('gameStatus'),
            usersList: document.getElementById('usersList'),
            userAvatar: document.getElementById('userAvatar'),
            userName: document.getElementById('userName'),
            userSymbol: document.getElementById('userSymbol')
        };

        // Event Listeners
        document.getElementById('avatarInput').addEventListener('change', handleAvatarUpload);
        document.getElementById('editAvatarInput').addEventListener('change', handleEditAvatarUpload);
        document.getElementById('editProfileForm').addEventListener('submit', handleProfileUpdate);

        // Game Initialization
        function initGame() {
            gameState.board = Array(9).fill(null);
            gameState.gameActive = true;
            elements.gameBoard.innerHTML = '';
            
            for(let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                cell.addEventListener('click', () => handleMove(i));
                elements.gameBoard.appendChild(cell);
            }
            
            updateGameStatus();
        }

        // AI Logic
        const AI = {
            easy: board => getRandomMove(board),
            
            medium: (board, player) => {
                const winMove = findWinningMove(board, player);
                if(winMove !== null) return winMove;
                const blockMove = findWinningMove(board, player === 'X' ? 'O' : 'X');
                return blockMove !== null ? blockMove : getRandomMove(board);
            },
            
            hard: (board, player) => {
                let bestScore = -Infinity;
                let bestMove = -1;
                
                for(let i = 0; i < 9; i++) {
                    if(board[i]) continue;
                    const newBoard = [...board];
                    newBoard[i] = player;
                    const score = minimax(newBoard, player, false);
                    if(score > bestScore) {
                        bestScore = score;
                        bestMove = i;
                    }
                }
                return bestMove;
            }
        };

        function minimax(board, player, isMaximizing) {
            if(checkWin(board, player)) return 1;
            if(checkWin(board, player === 'X' ? 'O' : 'X')) return -1;
            if(board.every(cell => cell)) return 0;
            
            let bestScore = isMaximizing ? -Infinity : Infinity;
            const currentPlayer = isMaximizing ? player : (player === 'X' ? 'O' : 'X');
            
            for(let i = 0; i < 9; i++) {
                if(board[i]) continue;
                const newBoard = [...board];
                newBoard[i] = currentPlayer;
                const score = minimax(newBoard, player, !isMaximizing);
                
                if(isMaximizing) {
                    bestScore = Math.max(bestScore, score);
                } else {
                    bestScore = Math.min(bestScore, score);
                }
            }
            return bestScore;
        }

        // Game Logic
        function handleMove(index) {
            if(!gameState.gameActive || gameState.board[index]) return;
            
            makeMove(index, gameState.currentPlayer);
            
            if(gameState.isMultiplayer) {
                socket.emit('gameMove', { index, roomId: gameState.roomId });
            } else if(gameState.currentPlayer !== currentUser.symbol) {
                setTimeout(() => {
                    const move = AI[gameState.difficulty](gameState.board, gameState.currentPlayer);
                    makeMove(move, gameState.currentPlayer);
                }, 500);
            }
        }

        function makeMove(index, player) {
            gameState.board[index] = player;
            const cell = document.querySelector(`[data-index="${index}"]`);
            cell.textContent = player;
            cell.classList.add(player.toLowerCase());

            if(checkWin(player)) {
                handleGameEnd(player);
            } else if(checkDraw()) {
                handleGameEnd('draw');
            } else {
                gameState.currentPlayer = player === 'X' ? 'O' : 'X';
                updateGameStatus();
            }
        }

        function checkWin(player) {
            const winPatterns = [
                [0,1,2], [3,4,5], [6,7,8],
                [0,3,6], [1,4,7], [2,5,8],
                [0,4,8], [2,4,6]
            ];

            return winPatterns.some(pattern => {
                const [a,b,c] = pattern;
                if(gameState.board[a] === player && 
                   gameState.board[b] === player && 
                   gameState.board[c] === player) {
                    pattern.forEach(i => 
                        document.querySelector(`[data-index="${i}"]`).classList.add('win')
                    );
                    return true;
                }
                return false;
            });
        }

        function checkDraw() {
            return gameState.board.every(cell => cell !== null);
        }

        function handleGameEnd(result) {
            gameState.gameActive = false;
            const popup = document.getElementById('resultPopup');
            
            if(result === 'draw') {
                popup.innerHTML = `<h2>It's a Draw!</h2>`;
                currentUser.draws++;
            } else {
                const isWinner = result === currentUser.symbol;
                popup.innerHTML = `<h2>You ${isWinner ? 'Win!' : 'Lose!'}</h2>`;
                isWinner ? currentUser.wins++ : currentUser.losses++;
            }
            
            popup.innerHTML += `
                <button class="btn btn-primary" onclick="rematch()">Rematch</button>
                <button class="btn btn-secondary" onclick="backToLobby()">Lobby</button>
            `;
            popup.style.display = 'block';
            
            currentUser.gamesPlayed++;
            socket.emit('updateStats', currentUser);
        }

        function updateGameStatus() {
            elements.gameStatus.textContent = gameState.isMultiplayer ?
                `${gameState.currentPlayer}'s Turn` : 
                gameState.currentPlayer === currentUser.symbol ?
                'Your Turn' : 'AI Thinking...';
        }

        // User Management
        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    elements.avatarPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function handleEditAvatarUpload(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('editAvatarPreview').src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function handleProfileUpdate(e) {
            e.preventDefault();
            currentUser.username = document.getElementById('editUsername').value;
            currentUser.symbol = document.querySelector('input[name="editSymbol"]:checked').value;
            currentUser.avatar = document.getElementById('editAvatarPreview').src;
            
            elements.userAvatar.src = currentUser.avatar;
            elements.userName.textContent = currentUser.username;
            elements.userSymbol.textContent = currentUser.symbol;
            
            socket.emit('userUpdated', currentUser);
            closeEditProfilePopup();
        }

        // Multiplayer Functions
        function challengeUser(socketId) {
            socket.emit('challengeUser', socketId);
        }

        function acceptChallenge(challengerId) {
            socket.emit('acceptChallenge', { challengerId });
            document.getElementById('challengePopup').style.display = 'none';
        }

        function declineChallenge(challengerId) {
            socket.emit('declineChallenge', { challengerId });
            document.getElementById('challengePopup').style.display = 'none';
        }

        // UI Functions
        function showScreen(screen) {
            Object.values(elements.screens).forEach(s => s.style.display = 'none');
            elements.screens[screen].style.display = 'block';
        }

        function renderUsersList() {
            elements.usersList.innerHTML = onlineUsers
                .filter(user => user.socketId !== socket.id)
                .map(user => `
                    <div class="player-card">
                        <img src="${user.avatar}" class="player-avatar">
                        <div class="player-info">
                            <h3>${user.username}</h3>
                            <p>Symbol: ${user.symbol}</p>
                            <button class="btn btn-primary" 
                                onclick="challengeUser('${user.socketId}')">
                                Challenge
                            </button>
                        </div>
                    </div>
                `).join('');
        }

        function toggleDropdown() {
            document.getElementById('profileDropdown').classList.toggle('show');
        }

        function editProfile() {
            document.getElementById('editUsername').value = currentUser.username;
            document.querySelector(`input[name="editSymbol"][value="${currentUser.symbol}"]`).checked = true;
            document.getElementById('editAvatarPreview').src = currentUser.avatar;
            document.getElementById('editProfilePopup').style.display = 'block';
        }

        function closeEditProfilePopup() {
            document.getElementById('editProfilePopup').style.display = 'none';
        }

        function showUserStats() {
            document.getElementById('gamesPlayed').textContent = currentUser.gamesPlayed;
            document.getElementById('wins').textContent = currentUser.wins;
            document.getElementById('losses').textContent = currentUser.losses;
            document.getElementById('draws').textContent = currentUser.draws;
            document.getElementById('userStatsPopup').style.display = 'block';
        }

        function closeUserStats() {
            document.getElementById('userStatsPopup').style.display = 'none';
        }

        function backToLobby() {
            showScreen('lobby');
            document.getElementById('resultPopup').style.display = 'none';
        }

        function rematch() {
            if(gameState.isMultiplayer) {
                socket.emit('rematch', gameState.roomId);
            } else {
                initGame();
            }
            document.getElementById('resultPopup').style.display = 'none';
        }

        function logout() {
            socket.emit('userLeft', currentUser);
            currentUser = null;
            showScreen('welcome');
        }

        // Socket Handlers
        socket.on('updateUsersList', users => {
            onlineUsers = users;
            renderUsersList();
        });

        socket.on('challengeReceived', challenger => {
            document.getElementById('challengeText').textContent = `${challenger.username} challenges you!`;
            document.getElementById('challengePopup').style.display = 'block';
        });

        socket.on('gameStart', roomId => {
            gameState.roomId = roomId;
            gameState.isMultiplayer = true;
            showScreen('game');
            initGame();
        });

        socket.on('gameUpdate', game => {
            gameState.board = game.board;
            gameState.currentPlayer = game.currentPlayer;
            updateBoard();
            updateGameStatus();
        });

        socket.on('gameEnd', result => {
            handleGameEnd(result.winner || 'draw');
        });

        // Initialization
        function login() {
            const username = elements.username.value.trim();
            const symbol = document.querySelector('input[name="symbol"]:checked').value;
            
            currentUser = {
                socketId: socket.id,
                username,
                symbol,
                avatar: elements.avatarPreview.src,
                wins: 0,
                losses: 0,
                draws: 0,
                gamesPlayed: 0
            };

            socket.emit('userJoined', currentUser);
            showScreen('lobby');
        }

        function startAIGame() {
            gameState.isMultiplayer = false;
            gameState.difficulty = document.getElementById('aiDifficulty').value;
            gameState.currentPlayer = 'X';
            showScreen('game');
            initGame();
            
            if(currentUser.symbol === 'O') {
                setTimeout(() => {
                    const move = AI[gameState.difficulty](gameState.board, 'X');
                    makeMove(move, 'X');
                }, 500);
            }
        }

        // Helper Functions
        function getRandomMove(board) {
            const emptyCells = board.reduce((acc, cell, index) => 
                cell === null ? [...acc, index] : acc, []);
            return emptyCells[Math.floor(Math.random() * emptyCells.length)];
        }

        function findWinningMove(board, player) {
            for(let i=0; i<9; i++) {
                if(board[i]) continue;
                const tempBoard = [...board];
                tempBoard[i] = player;
                if(checkWin(tempBoard, player)) return i;
            }
            return null;
        }

        function updateBoard() {
            gameState.board.forEach((cell, index) => {
                const element = document.querySelector(`[data-index="${index}"]`);
                element.textContent = cell;
                element.className = `cell${cell ? ' ' + cell.toLowerCase() : ''}`;
            });
        }
    </script>
</body>

</html>