<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --accent: #e74c3c;
            --background: #ecf0f1;
            --text: #2c3e50;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--background);
            min-height: 100vh;
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            padding: 2rem;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            padding: 2rem;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .active {
            display: block;
        }

        h1, h2, h3 {
            margin-bottom: 1rem;
            text-align: center;
            color: var(--primary);
        }

        /* Welcome Screen */
        #welcomeScreen {
            text-align: center;
        }

        /* Login Screen */
        #loginScreen {
            text-align: center;
        }

        .avatar-upload {
            position: relative;
            width: 150px;
            margin: 1rem auto;
        }

        #avatarPreview, #editAvatarPreview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        #avatarPreview:hover, #editAvatarPreview:hover {
            transform: scale(1.05);
        }

        .symbol-selection {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
        }

        .symbol-selection label {
            cursor: pointer;
        }

        .symbol-selection input:checked + span {
            background: var(--primary);
            color: white;
        }

        /* Lobby Screen */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            background: var(--background);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        #userAvatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .profile-actions {
            position: relative;
            margin-left: auto;
        }

        .dropdown {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--shadow);
            padding: 0.5rem;
            z-index: 100;
        }

        .dropdown.show {
            display: block;
        }

        #usersList {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .player-card {
            background: var(--background);
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .player-info {
            flex-grow: 1;
        }

        .player-symbol {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }

        /* Game Screen */
        #gameScreen {
            text-align: center;
        }

        #gameBoard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 2rem auto;
            background: var(--primary);
            padding: 10px;
            border-radius: 1rem;
            box-shadow: var(--shadow);
        }

        .cell {
            aspect-ratio: 1;
            background: white;
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cell:hover {
            background: var(--background);
        }

        .cell.x { color: var(--accent); }
        .cell.o { color: var(--secondary); }
        .cell.win { background: rgba(46, 204, 113, 0.2); }

        /* Popup */
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
            animation: scaleIn 0.3s ease-in-out;
        }

        @keyframes scaleIn {
            from { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Edit Profile Popup */
        #editProfilePopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
        }

        #editProfilePopup.show {
            display: block;
        }

        #editProfileForm {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Utility Classes */
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.5rem;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--background);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #bdc3c7;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        input[type="text"], select {
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            width: 100%;
            margin: 0.5rem 0;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen active">
            <h1>Welcome to Tic Tac Toe Advanced Game</h1>
            <p>Play with friends online or challenge our AI-Bot</p>
            <button class="btn btn-primary" onclick="showScreen('loginScreen')">Start Game</button>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="screen">
            <h2>Create Your Profile</h2>
            <div class="avatar-upload">
                <input type="file" id="avatarInput" accept="image/*" hidden>
                <img id="avatarPreview" src="https://via.placeholder.com/150" alt="Avatar">
                <button class="btn btn-secondary" onclick="document.getElementById('avatarInput').click()">Choose Avatar</button>
            </div>
            <input type="text" id="username" placeholder="Enter your name">
            <div class="symbol-selection">
                <label>
                    <input type="radio" name="symbol" value="X" id="symbol" checked hidden>
                    <span class="btn btn-secondary">X</span>
                </label>
                <label>
                    <input type="radio" name="symbol"  id="symbol" value="O" hidden>
                    <span class="btn btn-secondary">O</span>
                </label>
            </div>
            <button class="btn btn-primary" onclick="login()">Join Game</button>
        </div>

        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="screen">
            <div class="profile-header">
                <img id="userAvatar" src="https://via.placeholder.com/60" alt="Avatar">
                <h2>Welcome, <span id="userName"></span> ( Symbol : <span id="userSymbol"></span>)</h2>
                <div class="profile-actions">
                    <button class="btn btn-secondary" onclick="toggleDropdown()">Profile â–¼</button>
                    <div id="profileDropdown" class="dropdown">
                        <button class="btn btn-secondary" onclick="editProfile()">Edit Profile</button>
                        <button class="btn btn-secondary" onclick="showUserStats()">View Stats</button>
                        <button class="btn btn-secondary" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
            
            <div class="ai-section">
                <h3>Play With AI-Bot</h3>
                <select id="aiDifficulty" class="btn btn-secondary">
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
                <button class="btn btn-primary" onclick="startAIGame()">Play With AI</button>
            </div>

            <h3>Play With Online Players</h3>
            <div id="usersList"></div>
            
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <h2 id="gameStatus"></h2>
            <div id="gameBoard"></div>
            <div class="game-actions">
                <button class="btn btn-primary" id="rematchBtn" onclick="requestRematch()">Request Rematch</button>
                <button class="btn btn-secondary" id="backToLobbyBtn" onclick="showScreen('lobbyScreen')">Back to Lobby</button>
            </div>
        </div>

        <!-- Result Popup -->
        <div id="resultPopup" class="popup">
            <h2 id="resultText"></h2>
            <button class="btn btn-primary" onclick="requestRematch()">Rematch</button>
            <button class="btn btn-secondary" onclick="showScreen('lobbyScreen')">Back to Lobby</button>
        </div>

        <!-- Challenge Popup -->
        <div id="challengePopup" class="popup">
            <h2 id="challengeText"></h2>
            <button class="btn btn-primary" onclick="acceptChallenge()">Accept</button>
            <button class="btn btn-secondary" onclick="declineChallenge()">Decline</button>
        </div>

        <!-- User Stats Popup -->
        <div id="userStatsPopup" class="popup">
            <h2>Your Stats</h2>
            <p>Games Played: <span id="gamesPlayed"></span></p>
            <p>Wins: <span id="wins"></span></p>
            <p>Losses: <span id="losses"></span></p>
            <p>Draws: <span id="draws"></span></p>
            <p>Experience: <span id="experience"></span></p>
            <button class="btn btn-secondary" onclick="closeUserStats()">Close</button>
        </div>

        <!-- Edit Profile Popup -->
        <div id="editProfilePopup">
            <h2>Edit Profile</h2>
            <form id="editProfileForm">
                <div class="avatar-upload">
                    <input type="file" id="editAvatarInput" accept="image/*" hidden>
                    <img id="editAvatarPreview" src="/placeholder.svg" alt="Avatar">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('editAvatarInput').click()">Choose Avatar</button>
                </div>
                <input type="text" id="editUsername" placeholder="Enter your name">
                <div class="symbol-selection">
                    <label>
                        <input type="radio" name="editSymbol" value="X" hidden>
                        <span class="btn btn-secondary">X</span>
                    </label>
                    <label>
                        <input type="radio" name="editSymbol" value="O" hidden>
                        <span class="btn btn-secondary">O</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditProfilePopup()">Cancel</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script>
        // Initialize Socket.io
        const socket = io();
        // Game state
        let currentUser = null;
        let onlineUsers = [];
        let gameBoardState = Array(9).fill(null);
        let currentPlayer = "X";
        let gameActive = false;
        let isPlayingAI = false;
        let aiDifficulty = "easy";
        let currentOpponent = null;
        let currentOpponentSocketId = null; // Store opponent's socket ID
        let currentRoomId; // To store the current room ID

        // DOM Elements
        const screens = {
            welcomeScreen: document.getElementById("welcomeScreen"),
            loginScreen: document.getElementById("loginScreen"),
            lobbyScreen: document.getElementById("lobbyScreen"),
            gameScreen: document.getElementById("gameScreen")
        };

        const avatarInput = document.getElementById("avatarInput");
        const avatarPreview = document.getElementById("avatarPreview");
        const usernameInput = document.getElementById("username");
        const gameBoard = document.getElementById("gameBoard");
        const gameStatus = document.getElementById("gameStatus");
        const usersList = document.getElementById("usersList");
        const userAvatarImage = document.getElementById("userAvatar");
        const userNameSpan = document.getElementById("userName");
        const resultPopup = document.getElementById("resultPopup");
        const challengePopup = document.getElementById("challengePopup");
        const userStatsPopup = document.getElementById("userStatsPopup");

        // Show screens
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.remove("active"));
            screens[screenId].classList.add("active");
        }

        // Handle login
        function login() {
            const username = usernameInput.value;
            const symbol = document.querySelector("input[name='symbol']:checked").value;
            const avatar = avatarPreview.src;

            currentUser = {
                id: socket.id,
                username: username,
                symbol: symbol,
                avatar: avatar,
                wins: 0,
                losses: 0,
                draws: 0,
                experience: 0,
                socketId: socket.id 
            };

            socket.emit("userJoined", currentUser);
            showScreen("lobbyScreen");

            userNameSpan.textContent = username;
            userSymbol.textContent = symbol;
            userAvatarImage.src = avatar;
        }

        // Update Avatar Preview
        avatarInput.addEventListener('change', function () {
            if (this.files && this.files[0]) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    avatarPreview.src = e.target.result;
                }

                reader.readAsDataURL(this.files[0]);
            }
        });

                // Update Users List
                socket.on("updateUsersList", (users) => {
            onlineUsers = users;
            renderUserList(users);
        });

        function renderUserList(users) {
            usersList.innerHTML = "";
            users.forEach(user => {
                if (user.id !== socket.id) {
                    const playerCard = document.createElement("div");
                    playerCard.classList.add("player-card");
                    playerCard.innerHTML = `
                        <img src="${user.avatar}" alt="Avatar" style="width: 40px; height: 40px; border-radius: 50%;">
                        <div class="player-info">
                            <span>${user.username}</span>
                            <span class="player-symbol">(${user.symbol})</span>
                        </div>
                        <button class="btn btn-primary" onclick="challengeUser('${user.id}', '${user.socketId}')">Challenge</button>
                    `;
                    usersList.appendChild(playerCard);
                }
            });
        }

        function challengeUser(userId, opponentSocketId) {
            currentOpponent = onlineUsers.find(user => user.id === userId);
            currentOpponentSocketId = opponentSocketId;
            socket.emit('challengeUser', { opponentSocketId: opponentSocketId });
        }

        socket.on('challengeReceived', (data) => {
            const { challenger } = data;
            challengePopup.innerHTML = `
                <h2>${challenger.username} challenges you!</h2>
                <button class="btn btn-primary" onclick="acceptChallenge('${challenger.socketId}')">Accept</button>
                <button class="btn btn-secondary" onclick="declineChallenge('${challenger.socketId}')">Decline</button>
            `;
            challengePopup.style.display = "block";
        });

        function acceptChallenge(challengerSocketId) {
            socket.emit('acceptChallenge', { challengerSocketId });
            challengePopup.style.display = "none";
        }

        socket.on('rematchRequested', (data) => {
            const { requester } = data;
            resultPopup.innerHTML = `
                <h2>${requester.username} requests a rematch!</h2>
                <button class="btn btn-primary" onclick="acceptRematch('${requester.id}')">Accept</button>
                <button class="btn btn-secondary" onclick="declineRematch('${requester.id}')">Decline</button>
            `;
            resultPopup.style.display = "block";
        });

        socket.on('challengeAccepted', (data) => {
            const { accepter, roomId } = data;
            alert(`${accepter.username} accepted your challenge! Joining game...`);
            currentOpponentSocketId = accepter.id; // Store opponent's socket ID
            // Start the game or navigate to the game screen
            startGame(roomId);
        });

         // Handle joinRoom event
         socket.on('joinRoom', (roomId) => {
            console.log(`Joined room: ${roomId}`);
            startGame(roomId);
        });

        function acceptRematch(requesterSocketId) {
            socket.emit('acceptRematch', { accepterSocketId: socket.id, requesterSocketId: requesterSocketId });
            resultPopup.style.display = "none";
        }

        function declineRematch(requesterSocketId) {
            socket.emit('declineRematch', { declinerSocketId: socket.id, requesterSocketId: requesterSocketId });
            resultPopup.style.display = "none";
        }

        function requestRematch() {
            socket.emit('rematchRequest', { requesterSocketId: socket.id, opponentSocketId: currentOpponentSocketId });
        }


        // Start Game
        function startGame(roomId) {
            showScreen('gameScreen');
            gameBoard.innerHTML = '';
            gameBoardState = Array(9).fill(null);
            currentPlayer = 'X';
            gameActive = true;
            currentRoomId = roomId; // Store the current room ID
            gameStatus.textContent = `Your turn`; // Display initial turn

            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.index = i;
                cell.addEventListener('click', handleMove);
                gameBoard.appendChild(cell);
            }
        }

        // Handle Move
        function handleMove(event) {
            const cell = event.target;
            const index = cell.dataset.index;

            if (gameBoardState[index] || !gameActive) return;

            // Update game state
            gameBoardState[index] = currentPlayer;
            cell.textContent = currentPlayer;
            cell.classList.add(currentPlayer.toLowerCase());

            // Emit the move to the server
            socket.emit('gameMove', { move: { index, player: currentPlayer }, roomId: currentRoomId });

            // Switch player
            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            gameStatus.textContent = `Opponent's turn`;
        }

        // Opponent Move
        socket.on('opponentMove', (move) => {
            const { index, player } = move;
            const cell = gameBoard.querySelector(`[data-index="${index}"]`);

            gameBoardState[index] = player;
            cell.textContent = player;
            cell.classList.add(player.toLowerCase());

            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            gameStatus.textContent = `Your turn`;
        });

        function requestRematch() {
            socket.emit('rematchRequest', { requesterSocketId: socket.id, opponentSocketId: currentOpponentSocketId });
        }

        socket.on('rematchRequested', (data) => {
            const { requester } = data;
            resultPopup.innerHTML = `
                <h2>${requester.username} requests a rematch!</h2>
                <button class="btn btn-primary" onclick="acceptRematch('${requester.id}')">Accept</button>
                <button class="btn btn-secondary" onclick="declineRematch('${requester.id}')">Decline</button>
            `;
            resultPopup.style.display = "block";
        });

        function acceptRematch(requesterSocketId) {
            socket.emit('acceptRematch', { accepterSocketId: socket.id, requesterSocketId: requesterSocketId });
            resultPopup.style.display = "none";
        }

        function declineRematch(requesterSocketId) {
            socket.emit('declineRematch', { declinerSocketId: socket.id, requesterSocketId: requesterSocketId });
            resultPopup.style.display = "none";
        }

        socket.on('rematchAccepted', (accepter) => {
            alert(`${accepter.username} accepted the rematch!`);
            startGame(currentRoomId);
        });

        socket.on('rematchDeclined', (decliner) => {
            alert(`${decliner.username} declined the rematch.`);
        });

        // Logout
        function logout() {
            socket.emit('userLeft', currentUser);
            currentUser = null;
            onlineUsers = [];
            showScreen('welcomeScreen');
        }

        // Edit Profile
        function editProfile() {
            document.getElementById('editProfilePopup').classList.add('show');
        }

        function closeEditProfilePopup() {
            document.getElementById('editProfilePopup').classList.remove('show');
        }

        // Show User Stats
        function showUserStats() {
            document.getElementById('gamesPlayed').textContent = currentUser.gamesPlayed || 0;
            document.getElementById('wins').textContent = currentUser.wins || 0;
            document.getElementById('losses').textContent = currentUser.losses || 0;
            document.getElementById('draws').textContent = currentUser.draws || 0;
            document.getElementById('experience').textContent = currentUser.experience || 0;
            document.getElementById('userStatsPopup').style.display = "block";
        }

        function closeUserStats() {
            document.getElementById('userStatsPopup').style.display = "none";
        }
    </script>

</body>
</html>