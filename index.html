<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --accent: #e74c3c;
            --background: #ecf0f1;
            --text: #2c3e50;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--background);
            min-height: 100vh;
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            padding: 2rem;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            padding: 2rem;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .active {
            display: block;
        }

        h1, h2, h3 {
            margin-bottom: 1rem;
            text-align: center;
            color: var(--primary);
        }

        /* Welcome Screen */
        #welcomeScreen {
            text-align: center;
        }

        /* Login Screen */
        #loginScreen {
            text-align: center;
        }

        .avatar-upload {
            position: relative;
            width: 150px;
            margin: 1rem auto;
        }

        #avatarPreview, #editAvatarPreview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        #avatarPreview:hover, #editAvatarPreview:hover {
            transform: scale(1.05);
        }

        .symbol-selection {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
        }

        .symbol-selection label {
            cursor: pointer;
        }

        .symbol-selection input:checked + span {
            background: var(--primary);
            color: white;
        }

        /* Lobby Screen */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            background: var(--background);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        #userAvatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .profile-actions {
            position: relative;
            margin-left: auto;
        }

        .dropdown {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--shadow);
            padding: 0.5rem;
            z-index: 100;
        }

        .dropdown.show {
            display: block;
        }

        #usersList {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .player-card {
            background: var(--background);
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .player-info {
            flex-grow: 1;
        }

        .player-symbol {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }

        /* Game Screen */
        #gameScreen {
            text-align: center;
        }

        #gameBoard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 2rem auto;
            background: var(--primary);
            padding: 10px;
            border-radius: 1rem;
            box-shadow: var(--shadow);
        }

        .cell {
            aspect-ratio: 1;
            background: white;
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cell:hover {
            background: var(--background);
        }

        .cell.x { color: var(--accent); }
        .cell.o { color: var(--secondary); }
        .cell.win { background: rgba(46, 204, 113, 0.2); }

        /* Popup */
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
            animation: scaleIn 0.3s ease-in-out;
        }

        @keyframes scaleIn {
            from { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Edit Profile Popup */
        #editProfilePopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
        }

        #editProfilePopup.show {
            display: block;
        }

        #editProfileForm {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Utility Classes */
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.5rem;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--background);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #bdc3c7;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        input[type="text"], select {
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            width: 100%;
            margin: 0.5rem 0;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen active">
            <h1>Welcome to Tic Tac Toe Advanced Game</h1>
            <p>Play with friends online or challenge our AI-Bot</p>
            <button class="btn btn-primary" onclick="showScreen('loginScreen')">Start Game</button>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="screen">
            <h2>Create Your Profile</h2>
            <div class="avatar-upload">
                <input type="file" id="avatarInput" accept="image/*" hidden>
                <img id="avatarPreview" src="https://via.placeholder.com/150" alt="Avatar">
                <button class="btn btn-secondary" onclick="document.getElementById('avatarInput').click()">Choose Avatar</button>
            </div>
            <input type="text" id="username" placeholder="Enter your name">
            <div class="symbol-selection">
                <label>
                    <input type="radio" name="symbol" value="X" id="symbol" checked hidden>
                    <span class="btn btn-secondary">X</span>
                </label>
                <label>
                    <input type="radio" name="symbol"  id="symbol" value="O" hidden>
                    <span class="btn btn-secondary">O</span>
                </label>
            </div>
            <button class="btn btn-primary" onclick="login()">Join Game</button>
        </div>

        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="screen">
            <div class="profile-header">
                <img id="userAvatar" src="https://via.placeholder.com/60" alt="Avatar">
                <h2>Welcome, <span id="userName"></span> ( Symbol : <span id="userSymbol"></span>)</h2>
                <div class="profile-actions">
                    <button class="btn btn-secondary" onclick="toggleDropdown()">Profile â–¼</button>
                    <div id="profileDropdown" class="dropdown">
                        <button class="btn btn-secondary" onclick="editProfile()">Edit Profile</button>
                        <button class="btn btn-secondary" onclick="showUserStats()">View Stats</button>
                        <button class="btn btn-secondary" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
            
            <div class="ai-section">
                <h3>Play With AI-Bot</h3>
                <select id="aiDifficulty" class="btn btn-secondary">
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
                <button class="btn btn-primary" onclick="startAIGame()">Play With AI</button>
            </div>

            <h3>Play With Online Players</h3>
            <div id="usersList"></div>
            
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <h2 id="gameStatus"></h2>
            <div id="gameBoard"></div>
            <div class="game-actions">
                <button class="btn btn-primary" id="rematchBtn" onclick="requestRematch()">Request Rematch</button>
                <button class="btn btn-secondary" id="backToLobbyBtn" onclick="showScreen('lobbyScreen')">Back to Lobby</button>
            </div>
        </div>

        <!-- Result Popup -->
        <div id="resultPopup" class="popup">
            <h2 id="resultText"></h2>
            <button class="btn btn-primary" onclick="requestRematch()">Rematch</button>
            <button class="btn btn-secondary" onclick="showScreen('lobbyScreen')">Back to Lobby</button>
        </div>

        <!-- Challenge Popup -->
        <div id="challengePopup" class="popup">
            <h2 id="challengeText"></h2>
            <button class="btn btn-primary" onclick="acceptChallenge()">Accept</button>
            <button class="btn btn-secondary" onclick="declineChallenge()">Decline</button>
        </div>

        <!-- User Stats Popup -->
        <div id="userStatsPopup" class="popup">
            <h2>Your Stats</h2>
            <p>Games Played: <span id="gamesPlayed"></span></p>
            <p>Wins: <span id="wins"></span></p>
            <p>Losses: <span id="losses"></span></p>
            <p>Draws: <span id="draws"></span></p>
            <p>Experience: <span id="experience"></span></p>
            <button class="btn btn-secondary" onclick="closeUserStats()">Close</button>
        </div>

        <!-- Edit Profile Popup -->
        <div id="editProfilePopup">
            <h2>Edit Profile</h2>
            <form id="editProfileForm">
                <div class="avatar-upload">
                    <input type="file" id="editAvatarInput" accept="image/*" hidden>
                    <img id="editAvatarPreview" src="/placeholder.svg" alt="Avatar">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('editAvatarInput').click()">Choose Avatar</button>
                </div>
                <input type="text" id="editUsername" placeholder="Enter your name">
                <div class="symbol-selection">
                    <label>
                        <input type="radio" name="editSymbol" value="X" hidden>
                        <span class="btn btn-secondary">X</span>
                    </label>
                    <label>
                        <input type="radio" name="editSymbol" value="O" hidden>
                        <span class="btn btn-secondary">O</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditProfilePopup()">Cancel</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script>
        // Initialize Socket.io
        const socket = io();
        // Game state
        let currentUser = null;
        let onlineUsers = [];
        let gameBoardState = Array(9).fill(null);
        let currentPlayer = "X";
        let gameActive = false;
        let isPlayingAI = false;
        let aiDifficulty = "easy";
        let currentOpponent = null;

        // DOM Elements
        const screens = {
            welcomeScreen: document.getElementById("welcomeScreen"),
            loginScreen: document.getElementById("loginScreen"),
            lobbyScreen: document.getElementById("lobbyScreen"),
            gameScreen: document.getElementById("gameScreen")
        };

        const avatarInput = document.getElementById("avatarInput");
        const avatarPreview = document.getElementById("avatarPreview");
        const usernameInput = document.getElementById("username");
        const gameBoard = document.getElementById("gameBoard");
        const gameStatus = document.getElementById("gameStatus");
        const usersList = document.getElementById("usersList");
        const userAvatarImage = document.getElementById("userAvatar");
        const userNameSpan = document.getElementById("userName");
        const resultPopup = document.getElementById("resultPopup");
        const challengePopup = document.getElementById("challengePopup");
        const userStatsPopup = document.getElementById("userStatsPopup");

        // Show screens
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.remove("active"));
            screens[screenId].classList.add("active");
        }

        // Handle login
        function login() {
            const username = usernameInput.value;
            const symbol = document.querySelector("input[name='symbol']:checked").value;
            
            if (!username) {
                alert("Please enter a name.");
                return;
            }

            currentUser = {
                id: Math.random().toString(36).substr(2, 9),
                name: username,
                avatar: avatarPreview.src,
                symbol: symbol,
                stats: {
                    gamesPlayed: 0,
                    wins: 0,
                    losses: 0,
                    draws: 0,
                    experience: 0
                }
            };

            userAvatarImage.src = currentUser.avatar;
            userNameSpan.textContent = currentUser.name;
            document.getElementById("userSymbol").textContent = currentUser.symbol;
            // Emit user joined event
            socket.emit('userJoined', currentUser);

            showScreen("lobbyScreen");
            saveToLocalStorage();
        }

        // Avatar upload
        avatarInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = function () {
                    avatarPreview.src = reader.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Toggle profile dropdown
        function toggleDropdown() {
            document.getElementById("profileDropdown").classList.toggle("show");
        }

        // Edit profile
        function editProfile() {
            const editProfilePopup = document.getElementById('editProfilePopup');
            const editAvatarPreview = document.getElementById('editAvatarPreview');
            const editUsername = document.getElementById('editUsername');
            const editSymbolInputs = document.getElementsByName('editSymbol');

            editAvatarPreview.src = currentUser.avatar;
            editUsername.value = currentUser.name;
            editSymbolInputs.forEach(input => {
                if (input.value === currentUser.symbol) {
                    input.checked = true;
                }
            });

            editProfilePopup.classList.add('show');
        }

        // Close edit profile popup
        function closeEditProfilePopup() {
            document.getElementById('editProfilePopup').classList.remove('show');
        }

        // Handle edit profile form submission
        document.getElementById('editProfileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const newUsername = document.getElementById('editUsername').value;
            const newSymbol = document.querySelector('input[name="editSymbol"]:checked').value;
            const newAvatar = document.getElementById('editAvatarPreview').src;
            document.getElementById("userSymbol").textContent = newSymbol;
            if (newUsername && newUsername.trim() !== "") {
                currentUser.name = newUsername.trim();
                currentUser.symbol = newSymbol;
                currentUser.avatar = newAvatar;

                userAvatarImage.src = currentUser.avatar;
                userNameSpan.textContent = currentUser.name;

                saveToLocalStorage();
                socket.emit('userUpdated', currentUser);
                closeEditProfilePopup();
            }
        });

        // Handle avatar change in edit profile
        document.getElementById('editAvatarInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = function () {
                    document.getElementById('editAvatarPreview').src = reader.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Show user stats
        function showUserStats() {
            document.getElementById("gamesPlayed").textContent = currentUser.stats.gamesPlayed;
            document.getElementById("wins").textContent = currentUser.stats.wins;
            document.getElementById("losses").textContent = currentUser.stats.losses;
            document.getElementById("draws").textContent = currentUser.stats.draws;
            document.getElementById("experience").textContent = currentUser.stats.experience;
            userStatsPopup.style.display = "block";
        }

        // Close user stats popup
        function closeUserStats() {
            userStatsPopup.style.display = "none";
        }

        // Logout
        function logout() {
            socket.emit('userLeft', currentUser);
            currentUser = null;
            showScreen("welcomeScreen");
            localStorage.removeItem("ticTacToeUser");
        }

        // Update users list in lobby
        function updateUsersList() {
    usersList.innerHTML = '';
    onlineUsers.forEach(user => {
        if (user.id !== currentUser.id) {
            const playerCard = document.createElement('div');
            playerCard.classList.add('player-card');

            // Player Avatar
            const avatarImg = document.createElement('img');
            avatarImg.src = user.avatar;
            avatarImg.alt = "Avatar";
            avatarImg.style.width = '60px';
            avatarImg.style.height = '60px';
            avatarImg.style.borderRadius = '50%';

            // Player Info
            const playerInfo = document.createElement('div');
            playerInfo.className = 'player-info';

            const playerName = document.createElement('h4');
            playerName.textContent = user.name;

            const playerSymbol = document.createElement('p');
            playerSymbol.textContent = `Symbol: ${user.symbol}`;

            playerInfo.appendChild(playerName);
            playerInfo.appendChild(playerSymbol);

            // Challenge Button
            const challengeBtn = document.createElement('button');
            challengeBtn.className = 'btn btn-primary';
            challengeBtn.textContent = 'Challenge';
            challengeBtn.addEventListener('click', () => challengeUser(user.id));

            // Assemble Card
            playerCard.appendChild(avatarImg);
            playerCard.appendChild(playerInfo);
            playerCard.appendChild(challengeBtn);

            usersList.appendChild(playerCard);
        }
    });
}
        // In the challengeUser function
function challengeUser(userId) {
    socket.emit('challengeUser', { opponentId: userId });
}

// Add these socket listeners
socket.on('challengeReceived', ({ challenger, challengerSocketId }) => {
    currentOpponent = {
        ...challenger,
        socketId: challengerSocketId
    };
    document.getElementById("challengeText").textContent = 
        `${challenger.name} has challenged you!`;
    challengePopup.style.display = "block";
});

socket.on('challengeAccepted', ({ accepter, accepterSocketId }) => {
    currentOpponent = {
        ...accepter,
        socketId: accepterSocketId
    };
    // Join the game room
    socket.emit('joinRoom', currentOpponent.socketId);
    startGame(false);
});


        // Decline challenge
        function declineChallenge() {
            socket.emit('declineChallenge', { decliner: currentUser, challenger: currentOpponent });
            challengePopup.style.display = "none";
        }

        // Start AI game
        function startAIGame() {
            aiDifficulty = document.getElementById("aiDifficulty").value;
            isPlayingAI = true;
            startGame(true);
        }

        // Start game
        function startGame(isAI) {
            gameBoardState = Array(9).fill(null);
            currentPlayer = "X";
            gameActive = true;
            isPlayingAI = isAI;
            updateGameBoard();
            updateGameStatus();
            showScreen("gameScreen");
        }

        // Update game board
        function updateGameBoard() {
            gameBoard.innerHTML = '';
            gameBoardState.forEach((cell, index) => {
                const cellElement = document.createElement('div');
                cellElement.classList.add('cell');
                if (cell) {
                    cellElement.classList.add(cell.toLowerCase());
                    cellElement.textContent = cell;
                }
                cellElement.addEventListener('click', () => handleMove(index));
                gameBoard.appendChild(cellElement);
            });
        }

        // Handle move
        function handleMove(index) {
            if (!gameActive || gameBoardState[index] !== null) return;

            gameBoardState[index] = currentPlayer;
            updateGameBoard();

            if (!isPlayingAI) {
                socket.emit('gameMove', { player: currentUser, move: index });
            }

            if (checkWinner()) {
                gameActive = false;
                showResultPopup(`${currentPlayer} wins!`);
                updateStats(currentPlayer === currentUser.symbol ? 'win' : 'loss');
            } else if (gameBoardState.every(cell => cell !== null)) {
                gameActive = false;
                showResultPopup("It's a draw!");
                updateStats('draw');
            } else {
                currentPlayer = currentPlayer === "X" ? "O" : "X";
                updateGameStatus();
                if (isPlayingAI && currentPlayer !== currentUser.symbol) {
                    setTimeout(makeAIMove, 500);
                }
            }
        }

        // Make AI move
        function makeAIMove() {
            let index;
            switch (aiDifficulty) {
                case "easy":
                    index = getRandomEmptyCell();
                    break;
                case "medium":
                    index = Math.random() < 0.5 ? getBestMove() : getRandomEmptyCell();
                    break;
                case "hard":
                    index = getBestMove();
                    break;
            }
            handleMove(index);
        }

        // Get random empty cell
        function getRandomEmptyCell() {
            const emptyCells = gameBoardState.reduce((acc, cell, index) => 
                cell === null ? acc.concat(index) : acc, []);
            return emptyCells[Math.floor(Math.random() * emptyCells.length)];
        }

        // Get best move (unbeatable AI using minimax algorithm)
        function getBestMove() {
            let bestScore = -Infinity;
            let bestMove;
            for (let i = 0; i < 9; i++) {
                if (gameBoardState[i] === null) {
                    gameBoardState[i] = currentPlayer;
                    let score = minimax(gameBoardState, 0, false);
                    gameBoardState[i] = null;
                    if (score > bestScore) {
                        bestScore = score;
                        bestMove = i;
                    }
                }
            }
            return bestMove;
        }

        // Minimax algorithm
        function minimax(board, depth, isMaximizing) {
            if (checkWinner()) {
                return isMaximizing ? -1 : 1;
            } else if (board.every(cell => cell !== null)) {
                return 0;
            }

            if (isMaximizing) {
                let bestScore = -Infinity;
                for (let i = 0; i < 9; i++) {
                    if (board[i] === null) {
                        board[i] = currentPlayer;
                        let score = minimax(board, depth + 1, false);
                        board[i] = null;
                        bestScore = Math.max(score, bestScore);
                    }
                }
                return bestScore;
            } else {
                let bestScore = Infinity;
                for (let i = 0; i < 9; i++) {
                    if (board[i] === null) {
                        board[i] = currentPlayer === "X" ? "O" : "X";
                        let score = minimax(board, depth + 1, true);
                        board[i] = null;
                        bestScore = Math.min(score, bestScore);
                    }
                }
                return bestScore;
            }
        }

        // Check for winner
        function checkWinner() {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6] // Diagonals
            ];

            return winPatterns.some(pattern => {
                const [a, b, c] = pattern;
                return gameBoardState[a] && 
                       gameBoardState[a] === gameBoardState[b] && 
                       gameBoardState[a] === gameBoardState[c];
            });
        }

        // Update game status
        function updateGameStatus() {
            gameStatus.textContent = `Current player: ${currentPlayer}`;
        }

        // Show result popup
        function showResultPopup(resultText) {
            document.getElementById("resultText").textContent = resultText;
            resultPopup.style.display = "block";
        }

        // Request rematch
        function requestRematch() {
            if (isPlayingAI) {
                startGame(true);
            } else {
                socket.emit('rematchRequest', { requester: currentUser, opponent: currentOpponent });
            }
            resultPopup.style.display = "none";
        }

        // Update user stats
        function updateStats(result) {
            currentUser.stats.gamesPlayed++;
            switch (result) {
                case 'win':
                    currentUser.stats.wins++;
                    currentUser.stats.experience += 10;
                    break;
                case 'loss':
                    currentUser.stats.losses++;
                    currentUser.stats.experience += 5;
                    break;
                case 'draw':
                    currentUser.stats.draws++;
                    currentUser.stats.experience += 3;
                    break;
            }
            saveToLocalStorage();
            socket.emit('updateStats', currentUser);
        }

        // Save user data to local storage
        function saveToLocalStorage() {
            localStorage.setItem("ticTacToeUser", JSON.stringify(currentUser));
        }

        // Load user data from local storage
        function loadFromLocalStorage() {
            const savedUser = localStorage.getItem("ticTacToeUser");
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                userAvatarImage.src = currentUser.avatar;
                userNameSpan.textContent = currentUser.name;
                showScreen("lobbyScreen");
                socket.emit('userJoined', currentUser);
            }
        }

        // Socket.io event listeners
        socket.on('updateUsersList', (users) => {
            onlineUsers = users;
            updateUsersList();
        });

        socket.on('challengeReceived', (challenger) => {
            currentOpponent = challenger;
            document.getElementById("challengeText").textContent = `${challenger.name} has challenged you to a game!`;
            challengePopup.style.display = "block";
        });

        socket.on('challengeAccepted', (accepter) => {
            currentOpponent = accepter;
            startGame(false);
        });

        socket.on('challengeDeclined', (decliner) => {
            alert(`${decliner.name} has declined your challenge.`);
        });

        socket.on('opponentMove', (move) => {
            handleMove(move);
        });

        socket.on('rematchRequested', (requester) => {
            if (confirm(`${requester.name} wants a rematch. Accept?`)) {
                socket.emit('acceptRematch', { accepter: currentUser, requester });
                startGame(false);
            } else {
                socket.emit('declineRematch', { decliner: currentUser, requester });
            }
        });

        // Initialize the game
        loadFromLocalStorage();
        if (!currentUser) {
            showScreen("welcomeScreen");
        }
    </script>
</body>
</html>